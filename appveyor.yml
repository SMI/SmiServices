version: 1.0.{build}
init:
  - git config --global core.autocrlf true
image: Visual Studio 2019
services:
  - mssql2017
  - mysql
  - postgresql101
  - mongodb
  
before_build:
- dotnet restore --packages ./packages
- choco install opencover.portable
- choco install rabbitmq

build_script:
  - ps: Remove-Item "./tests/common/Smi.Common.Tests/TestDatabases.txt"
  - ps: Rename-Item -Path "./tests/common/Smi.Common.Tests/TestDatabases.appveyor.txt" -NewName "TestDatabases.txt"
  
  - ps: "[Net.ServicePointManager]::SecurityProtocol = \"tls12, tls11, tls\""
  - ps: "New-Item -Path \".\" -Name \"rdmp-cli\" -ItemType \"directory\""
  - ps:  Invoke-WebRequest https://github.com/HicServices/RDMP/releases/download/v4.1.1/rdmp-cli-win-x64.zip -OutFile rdmp-cli-win-x64.zip
  - ps: 7z x rdmp-cli-win-x64.zip -o ./rdmp-cli
  - ps: ./rdmp-cli/rdmp.exe install localhost\SQL2017 TEST_ -D -u sa -p Password12!
 
  - ps: dotnet test ./tests/run-all-tests.proj
 
  # Run code coverage on non UI tests (UI tests run in net461 while the rest run in netcoreapp2.2)
  #- cmd: "\"packages/opencover/4.7.922/tools/OpenCover.Console.exe\" -target:\"c:/program files/dotnet/dotnet.exe\" -targetargs:\"test ./tests/run-all-tests.proj -f netcoreapp2.2 -c Release -p:BuildInParallel=false\" -filter:\"+[*Rdmp.Core*]* +[*ReusableLibraryCode*]* +[*MapsDirectlyToDatabaseTable*]* -[*Tests*]*\"  -output:coverage.xml -register:appveyor -oldStyle -hideskipped:File"
  #- cmd: packages\coveralls.io\1.4.2\tools\coveralls.net.exe --opencover coverage.xml -r %COVERALLS_REPO_TOKEN%

test: off