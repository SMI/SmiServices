# Cohort Packager

Primary Author: [Ruairidh MacLeod](https://github.com/rkm)

## Contents

1.  [Overview](#1-overview)
2.  [Setup / Installation](#2-setup--installation)
3.  [Queue Settings](#3-queue-settings)
4.  [Config](#4-config)
5.  [Expectations](#5-expectations)
6.  [Reports](#6-reports)

### 1. Overview

Collects all information regarding an extraction job, and monitors the filesystem for the anonymised files. Persists all information to a MongoDB collection.

Produces validation reports for each extraction suitable for review by research coordinators before the extraction files are released. See [reports section](#6-reports). Reports are created automatically when an extraction is detected as being complete, and can also be manually recreated on the CLI by passing the `-r` or `--recreate-reports` flag with the corresponding extraction GUID.

### 2. Setup / Installation

-   Clone the project and build. Any NuGet dependencies should be automatically downloaded
-   Setup a yaml file with the configuration for your environment
-   Run `CohortPackager.exe` with your yaml config

### 3. Exchange and Queue Settings

| Read/Write | Type                      | Config setting                                      |
| ---------- | ------------------------- | --------------------------------------------------- |
| Read       | ExtractRequestMessage     | `DicomReprocessorOptions.ExtractRequestInfoOptions` |
| Read       | ExtractRequestInfoMessage | `DicomReprocessorOptions.ExtractFilesInfoOptions`   |
| Read       | ExtractFileStatusMessage  | `DicomReprocessorOptions.AnonImageStatusOptions`    |

### 4. Config

| YAML Section       | Purpose                                                               |
| ------------------ | --------------------------------------------------------------------- |
| JobWatcherTickrate | How often the filesystem is checked for anonymised files (in seconds) |

### 5. Expectations

Errors are [logged as normal for a MicroserviceHost](../../common/Smi.Common/README.md#logging)

### 6. Reports

When an extraction is completed, a set of reports are created detailing any errors or validation failures relating to the set of files that have been produced.

For a standard extraction, 4 files are produced:

-   `README.md` - A summary file containing metadata about the extraction job
-   `rejected_files.csv` - A list of any requested IDs which generated a rejection (a file was blocked etc.)
-   `processing_errors.csv` - A summary of any errors from the anonymiser or other components in the pipeline. This report should be inspected by a developer before data are released
-   `verification_failures.csv` - A full listing of all `Failure`s generated by IsIdentifiable when scanning files after anonymisation

For an identifiable extraction, the `verification_failures.csv` is not produced.
