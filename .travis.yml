merge_mode: replace
dist: bionic
os: linux
language: generic

jobs:
  include:
    cache:
      directories:
      - $HOME/.local/share/NuGet/
      - $HOME/.nuget
      - $HOME/.m2
      - $HOME/rdmp-cli
      - $HOME/data
    addons:
      postgresql: "10"
    services:
    - postgresql
    - mysql
    - redis
    env:
    - MSSQL_SA_PASSWORD="YourStrong!Passw0rd"
    - ACCEPT_EULA=Y
    - MSSQL_PID='developer'

    before_install:
    - cat lib/travis/*.asc | sudo -E apt-key add -
    - sort ${TRAVIS_ROOT}/etc/apt/sources.list lib/travis/apt.sources | uniq | sudo tee ${TRAVIS_ROOT}/etc/apt/sources.list >/dev/null
    - sudo apt-get -q update
    - sudo apt-get -q install -y --no-install-recommends pigz rabbitmq-server libgdiplus tesseract-ocr libtesseract-dev maven dotnet-runtime-2.2 dotnet-sdk-3.1 dotnet-runtime-3.1
    - sudo apt-get -q install -y --no-install-recommends mssql-tools mssql-server
    - sudo /opt/mssql/bin/mssql-conf -n setup accept-eula

    install:
    - ( cd ./lib/java && ./installDat.sh && cd - )
    - |
      echo -e '\nreplication:\n  replSetName: rs0' | sudo tee -a /etc/mongod.conf >/dev/null &&
      sudo systemctl start mongod
      COUNTER=0
      sudo grep -q 'waiting for connections on port' /var/log/mongodb/mongod.log
      while [[ $? -ne 0 && $COUNTER -lt 60 ]] ; do
          sleep 1
          let COUNTER+=1
          echo "Waiting for mongo to initialize... ($COUNTER seconds so far)"
          sudo grep -q 'waiting for connections on port' /var/log/mongodb/mongod.log
      done
      mongo --eval 'rs.initiate()'
    - export RDMPVERSION=$(fgrep -m1 HIC.RDMP.Plugin src/common/Smi.Common/Smi.Common.csproj|sed -n 's/.*Version="\([0-9.]*\)".*/\1/p')
    - |
      if [ ! -x $HOME/rdmp-cli/rdmp ] || ! fgrep -q $RDMPVERSION $HOME/rdmp-cli/rdmp.dll
      then
        rm -rf $HOME/rdmp-cli
        wget https://github.com/HicServices/RDMP/releases/download/v${RDMPVERSION}/rdmp-cli-linux-x64.zip
        # RDMP is still being packaged using a ZIP tool with a bug Microsoft fixed in .Net 4.6.1; excluding Chinese language support file and keyword help avoids unzip being affected by the bug: https://docs.microsoft.com/en-us/dotnet/framework/migration-guide/mitigation-ziparchiveentry-fullname-path-separator?redirectedfrom=MSDN
        unzip -d $HOME/rdmp-cli rdmp-cli-linux-x64.zip -x "Curation*" "zh-*"
        chmod +x $HOME/rdmp-cli/rdmp
      fi
    - $HOME/rdmp-cli/rdmp install localhost TEST_ -u sa -p 'YourStrong!Passw0rd'
    - if [ -e $HOME/data/eng.traineddata ]; then ln $HOME/data/eng.traineddata data/tessdata/; fi
    - ( cd data/tessdata && ./download.sh && ln -f eng.traineddata $HOME/data/ && cd - )

    script:
    - dotnet build -c Release --verbosity quiet
    - for i in `find . -type d -name netcoreapp3.1`; do if [ ! -e $i/default.yaml ]; then ln data/microserviceConfigs/default.yaml $i/ ; fi ; done
    - find ./tests -iname "*.csproj" -print0 | xargs -0 -L 1 dotnet test -p:Platform=x64 -c Release --verbosity=normal --no-build -s data/nunit.runsettings
    - 'if [ -f lib/java/Util/source/java/org/rsna/util/ChunkedInputStream.java ] ; then iconv -f iso-8859-1 -t utf-8 lib/java/Util/source/java/org/rsna/util/ChunkedInputStream.java > tmpiconv && mv tmpiconv lib/java/Util/source/java/org/rsna/util/ChunkedInputStream.java; fi'
    - mvn -ntp -q -f src/common/com.smi.microservices.parent/pom.xml test
    - mvn -ntp -q -f src/microservices/uk.ac.dundee.hic.nerd/ test

    - |
      if [ ! -z "$TRAVIS_TAG" ]
      then
        mkdir -p ./dist
        for platform in linux win
        do
          dotnet publish -p:PublishTrimmed=false -c Release -r $platform-x64 -o $(pwd)/dist/$platform-x64 -nologo -v q
        done
        ( cd dist && zip -9r smi-services-win-x64-$TRAVIS_TAG.zip ./win-x64 && tar cf - ./linux-x64 | pigz -3 > smi-services-linux-x64-$TRAVIS_TAG.tar.gz && cd - )
        mvn -ntp -q -f src/common/com.smi.microservices.parent/pom.xml install assembly:single@create-deployable -DskipTests
        mvn -ntp -q -f src/microservices/uk.ac.dundee.hic.nerd/ package -DskipTests
        for filename in $(find ./src -name "*deploy-distribution.zip")
        do
          base=$(ls $filename | awk -F'-' '{print $1}' | awk -F'/' '{print $6}')
          mv $filename dist/$base-${TRAVIS_TAG}.zip
        done
        mv src/microservices/uk.ac.dundee.hic.nerd/target/nerd-*.jar dist/nerd-${TRAVIS_TAG}.jar
        ls -lh dist/
      fi

deploy:
      provider: releases
      token:
        secure: DdirbOkYUePnKisYPlqYOpyti2HQFWmSIwY5spWflTUglzEZbnp+Q3sEltTebdlWo18i9skz6P5seAAXbX2ye1c3EZhqEyirWMxz1lvGdlNoQGHhWK6x+suM1DrG6Uun5dmcG/CEpWhDpcEbF8xQ/revtyCHEJj4xK9TXUHyFFG/KrzKSLGtsiBG1BOPkHJr4CoHjcpLzpmDB2hn+pYENtl3Nk0EeKmJgWdY/BWctEmUmRAXgfwsO/ejm9IbC5mIy5KBxbIUco/mf2JEKQB1drwdbINMxJXkbx+mWZYiDJBo5CWuWIzNOxv0Z3+Kg+N2cSwPX833v+W5YRTHyef/7Dum1yUrD3T7LMLY+3EIeCoGvARfRnQbi+BM9n1rFobPy/PWHWYxYRDnhDEfXrMcAyH/66InlQIhUh7XD01oZLEbsdZAbGnEsv5Ttz3F9LaEpk3EfoGqLxOWkL50OCxw6Jk6TfxsNtMoLpK1g7Jp8sI/EkjxYISer7S5myzLhKtgbtBwI0RcKh/sUo2m69QX++1JYy6CeN7/EwRmV4zJLk0WgalJuxgNFYrdzPLvg09okgxr1stHZQ7a5RkLH+r8KzA/Lmj6vTQG9HB44lHvX1hMiD0v8aCii+/wfr9AZZlNHjYq8RuHsP5uQ5U5F8G9uMqfiVb75MOPKY7qdYCZZZg=
      file_glob: true
      file: dist/*.*
      skip_cleanup: true
      on:
        all_branches: true
        tags: true
